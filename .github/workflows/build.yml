name: Build Executables

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-20.04
            platform: linux
            arch: x64
          - os: windows-latest
            platform: windows
            arch: x64
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
    
    - name: Build and Package Stun_Frps (Linux)
      if: matrix.platform == 'linux'
      run: |
        cd Stun_Frps
        pyinstaller --onefile --icon=NONE --name stun_frps_linux_x64 Stun_Frps.py
        
        # åˆ›å»ºå‘å¸ƒç›®å½•ç»“æ„
        mkdir -p ../release/stun_frps_linux_x64/Linux
        mkdir -p ../release/stun_frps_linux_x64/Natter
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp dist/stun_frps_linux_x64 ../release/stun_frps_linux_x64/
        
        # å¤åˆ¶å¿…è¦çš„æ–‡ä»¶å’Œç›®å½•
        cp .env.example ../release/stun_frps_linux_x64/
        cp Stun_Port.toml ../release/stun_frps_linux_x64/
        cp Linux/frps ../release/stun_frps_linux_x64/Linux/
        cp Linux/frps.toml ../release/stun_frps_linux_x64/Linux/
        cp Natter/natter.py ../release/stun_frps_linux_x64/Natter/
        
        # åˆ›å»º README
        cat > ../release/stun_frps_linux_x64/README.txt << 'EOF'
        Stun-FRP Server (Linux x64)
        ============================
        
        å¿«é€Ÿå¼€å§‹:
        1. å¤åˆ¶ .env.example ä¸º .env å¹¶ç¼–è¾‘é…ç½®
        2. ç¼–è¾‘ Stun_Port.toml é…ç½®ç«¯å£
        3. è¿è¡Œ: chmod +x stun_frps_linux_x64 && ./stun_frps_linux_x64
        
        è¯¦ç»†æ–‡æ¡£: https://github.com/yuexps/stun-frp
        EOF
        
        # æ‰“åŒ…
        cd ../release
        tar -czf stun_frps_linux_x64.tar.gz stun_frps_linux_x64
        ls -lh
    
    - name: Build and Package Stun_Frpc (Linux)
      if: matrix.platform == 'linux'
      run: |
        cd Stun_Frpc
        pyinstaller --onefile --icon=NONE --name stun_frpc_linux_x64 Stun_Frpc.py
        
        # åˆ›å»ºå‘å¸ƒç›®å½•ç»“æ„
        mkdir -p ../release/stun_frpc_linux_x64/Linux
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp dist/stun_frpc_linux_x64 ../release/stun_frpc_linux_x64/
        
        # å¤åˆ¶å¿…è¦çš„æ–‡ä»¶å’Œç›®å½•
        cp .env.example ../release/stun_frpc_linux_x64/
        cp Linux/frpc ../release/stun_frpc_linux_x64/Linux/
        cp Linux/frpc.toml ../release/stun_frpc_linux_x64/Linux/
        
        # åˆ›å»º README
        cat > ../release/stun_frpc_linux_x64/README.txt << 'EOF'
        Stun-FRP Client (Linux x64)
        ============================
        
        å¿«é€Ÿå¼€å§‹:
        1. å¤åˆ¶ .env.example ä¸º .env å¹¶ç¼–è¾‘é…ç½®
        2. è¿è¡Œ: chmod +x stun_frpc_linux_x64 && ./stun_frpc_linux_x64
        3. ç¨‹åºä¼šè‡ªåŠ¨ç”Ÿæˆ Linux/frpc{å®¢æˆ·ç«¯ç¼–å·}.tomlï¼Œå¯ç¼–è¾‘æ­¤æ–‡ä»¶é…ç½®å¯¹åº”ä»£ç†(åªå»ºè®®æŒ‰éœ€ä¿®æ”¹ `localPort` )
        
        è¯¦ç»†æ–‡æ¡£: https://github.com/yuexps/stun-frp
        EOF
        
        # æ‰“åŒ…
        cd ../release
        tar -czf stun_frpc_linux_x64.tar.gz stun_frpc_linux_x64
        ls -lh
    
    - name: Build and Package Stun_Frps (Windows)
      if: matrix.platform == 'windows'
      run: |
        cd Stun_Frps
        pyinstaller --onefile --icon=NONE --name stun_frps_windows_x64 Stun_Frps.py
        
        # åˆ›å»ºå‘å¸ƒç›®å½•ç»“æ„
        New-Item -ItemType Directory -Force -Path ..\release\stun_frps_windows_x64\Windows
        New-Item -ItemType Directory -Force -Path ..\release\stun_frps_windows_x64\Natter
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        Copy-Item dist\stun_frps_windows_x64.exe ..\release\stun_frps_windows_x64\
        
        # å¤åˆ¶å¿…è¦çš„æ–‡ä»¶å’Œç›®å½•
        Copy-Item .env.example ..\release\stun_frps_windows_x64\
        Copy-Item Stun_Port.toml ..\release\stun_frps_windows_x64\
        Copy-Item Windows\frps.exe ..\release\stun_frps_windows_x64\Windows\
        Copy-Item Windows\frps.toml ..\release\stun_frps_windows_x64\Windows\
        Copy-Item Natter\natter.py ..\release\stun_frps_windows_x64\Natter\
        
        # åˆ›å»º README
        @"
        Stun-FRP Server (Windows x64)
        ==============================
        
        å¿«é€Ÿå¼€å§‹:
        1. å¤åˆ¶ .env.example ä¸º .env å¹¶ç¼–è¾‘é…ç½®
        2. ç¼–è¾‘ Stun_Port.toml é…ç½®ç«¯å£
        3. åŒå‡»è¿è¡Œ: stun_frps_windows_x64.exe
        
        è¯¦ç»†æ–‡æ¡£: https://github.com/yuexps/stun-frp
        "@ | Out-File -FilePath ..\release\stun_frps_windows_x64\README.txt -Encoding UTF8
        
        # æ‰“åŒ…
        cd ..\release
        Compress-Archive -Path stun_frps_windows_x64\* -DestinationPath stun_frps_windows_x64.zip
        dir
    
    - name: Build and Package Stun_Frpc (Windows)
      if: matrix.platform == 'windows'
      run: |
        cd Stun_Frpc
        pyinstaller --onefile --icon=NONE --name stun_frpc_windows_x64 Stun_Frpc.py
        
        # åˆ›å»ºå‘å¸ƒç›®å½•ç»“æ„
        New-Item -ItemType Directory -Force -Path ..\release\stun_frpc_windows_x64\Windows
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        Copy-Item dist\stun_frpc_windows_x64.exe ..\release\stun_frpc_windows_x64\
        
        # å¤åˆ¶å¿…è¦çš„æ–‡ä»¶å’Œç›®å½•
        Copy-Item .env.example ..\release\stun_frpc_windows_x64\
        Copy-Item Windows\frpc.exe ..\release\stun_frpc_windows_x64\Windows\
        Copy-Item Windows\frpc.toml ..\release\stun_frpc_windows_x64\Windows\
        
        # åˆ›å»º README
        @"
        Stun-FRP Client (Windows x64)
        ==============================
        
        å¿«é€Ÿå¼€å§‹:
        1. å¤åˆ¶ .env.example ä¸º .env å¹¶ç¼–è¾‘é…ç½®
        2. åŒå‡»è¿è¡Œ: stun_frpc_windows_x64.exe
        3. ç¨‹åºä¼šè‡ªåŠ¨ç”Ÿæˆ Windows\frpc{å®¢æˆ·ç«¯ç¼–å·}.tomlï¼Œå¯ç¼–è¾‘æ­¤æ–‡ä»¶é…ç½®å¯¹åº”ä»£ç†(åªå»ºè®®æŒ‰éœ€ä¿®æ”¹ `localPort` )
        
        è¯¦ç»†æ–‡æ¡£: https://github.com/yuexps/stun-frp
        "@ | Out-File -FilePath ..\release\stun_frpc_windows_x64\README.txt -Encoding UTF8
        
        # æ‰“åŒ…
        cd ..\release
        Compress-Archive -Path stun_frpc_windows_x64\* -DestinationPath stun_frpc_windows_x64.zip
        dir
    
    - name: Upload Stun_Frps Package (Linux)
      if: matrix.platform == 'linux'
      uses: actions/upload-artifact@v4
      with:
        name: stun_frps_linux_x64
        path: release/stun_frps_linux_x64.tar.gz
        retention-days: 90
    
    - name: Upload Stun_Frpc Package (Linux)
      if: matrix.platform == 'linux'
      uses: actions/upload-artifact@v4
      with:
        name: stun_frpc_linux_x64
        path: release/stun_frpc_linux_x64.tar.gz
        retention-days: 90
    
    - name: Upload Stun_Frps Package (Windows)
      if: matrix.platform == 'windows'
      uses: actions/upload-artifact@v4
      with:
        name: stun_frps_windows_x64
        path: release/stun_frps_windows_x64.zip
        retention-days: 90
    
    - name: Upload Stun_Frpc Package (Windows)
      if: matrix.platform == 'windows'
      uses: actions/upload-artifact@v4
      with:
        name: stun_frpc_windows_x64
        path: release/stun_frpc_windows_x64.zip
        retention-days: 90

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Display structure of downloaded files
      run: ls -R artifacts
    
    - name: Delete old pre-release
      continue-on-error: true
      run: |
        gh release delete pre --yes || true
        git push origin :refs/tags/pre || true
      env:
        GH_TOKEN: ${{ github.token }}
    
    - name: Create Pre-Release and Upload Assets
      uses: softprops/action-gh-release@v2
      with:
        tag_name: pre
        name: ğŸš€ Latest Build (Pre-release)
        body: |
          ## ğŸ“¦ æœ€æ–°æ„å»ºç‰ˆæœ¬
          
          > âš ï¸ è¿™æ˜¯è‡ªåŠ¨æ„å»ºçš„é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œæ¯æ¬¡æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨æ›´æ–°
          > 
          > ğŸ“… æ„å»ºæ—¶é—´ï¼š${{ github.event.head_commit.timestamp }}
          > ğŸ“ æœ€æ–°æäº¤ï¼š${{ github.event.head_commit.message }}
          > ğŸ‘¤ æäº¤è€…ï¼š${{ github.event.head_commit.author.name }}
          
          ### Linux ç‰ˆæœ¬
          - **stun_frps_linux_x64.tar.gz** - FrpsæœåŠ¡ç«¯
          - **stun_frpc_linux_x64.tar.gz** - Frpcå®¢æˆ·ç«¯
          
          ### Windows ç‰ˆæœ¬
          - **stun_frps_windows_x64.zip** - FrpsæœåŠ¡ç«¯
          - **stun_frpc_windows_x64.zip** - Frpcå®¢æˆ·ç«¯
          
          ### ä½¿ç”¨æ–¹æ³•
          
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
          2. è§£å‹åè¿›å…¥ç›®å½•
          3. å¤åˆ¶ `.env.example` ä¸º `.env` å¹¶ç¼–è¾‘é…ç½®
          4. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
          
          è¯¦ç»†æ–‡æ¡£ï¼š[README.md](https://github.com/yuexps/stun-frp)
        draft: false
        prerelease: true
        make_latest: false
        files: |
          artifacts/stun_frps_linux_x64/stun_frps_linux_x64.tar.gz
          artifacts/stun_frpc_linux_x64/stun_frpc_linux_x64.tar.gz
          artifacts/stun_frps_windows_x64/stun_frps_windows_x64.zip
          artifacts/stun_frpc_windows_x64/stun_frpc_windows_x64.zip
